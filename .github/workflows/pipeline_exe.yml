name: Build and Upload Executable

on:
  push:
    branches:
      - main

env:
  pythonVersion: '3.11'
  pythonFilePath: 'app.py'

jobs:

  validate:
    name: Validate Python File
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.pythonVersion }}

      - name: Validate Python file exists
        run: |
          echo "Validating file path: ${{ env.pythonFilePath }}"
          if [ ! -f "${{ env.pythonFilePath }}" ]; then
            echo "File not found: ${{ env.pythonFilePath }}"
            exit 1
          fi

      - name: Install dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      - name: Validate Python syntax
        run: python -m py_compile "${{ env.pythonFilePath }}"

  approval:
    name: Manual Approval
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions
    steps:
      - name: Display approval info
        run: |
          echo "Python file: ${{ env.pythonFilePath }}"
          echo "Please review validation results before proceeding."

  build_exe:
    name: Build Executable
    needs: approval
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.pythonVersion }}

      - name: Install dependencies
        run: |
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
        shell: pwsh

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build executable
        run: pyinstaller --onefile --clean "${{ env.pythonFilePath }}"

      - name: Timestamp EXE
        run: |
          $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
          Get-ChildItem -Path dist -Filter *.exe | ForEach-Object {
            Rename-Item $_.FullName ($_.BaseName + '_' + $timestamp + $_.Extension)
          }
        shell: pwsh

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: executable
          path: dist/*.exe

  upload_drive:
    name: Upload to Google Drive (OAuth)
    needs: build_exe
    runs-on: ubuntu-latest
    steps:
      - name: Download executable artifact
        uses: actions/download-artifact@v4
        with:
          name: executable
          path: executable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.pythonVersion }}

      - name: Install Google API client
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Create upload script (OAuth)
        run: |
          cat > upload_to_drive_oauth.py << 'EOF'
          from google.oauth2.credentials import Credentials
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          import os
          import sys

          gdrive_folder_id = os.environ.get('GOOGLE_DRIVE_FOLDER_ID')
          client_id = os.environ.get('GOOGLE_CLIENT_ID')
          client_secret = os.environ.get('GOOGLE_CLIENT_SECRET')
          refresh_token = os.environ.get('GOOGLE_REFRESH_TOKEN')

          def get_credentials():
              return Credentials(
                  None,
                  refresh_token=refresh_token,
                  token_uri='https://oauth2.googleapis.com/token',
                  client_id=client_id,
                  client_secret=client_secret,
                  scopes=['https://www.googleapis.com/auth/drive.file']
              )

          def upload_file(file_path):
              creds = get_credentials()
              service = build('drive', 'v3', credentials=creds)

              file_metadata = {
                  'name': os.path.basename(file_path),
                  'parents': [gdrive_folder_id]
              }
              media = MediaFileUpload(file_path, resumable=True)
              
              uploaded = service.files().create(
                  body=file_metadata,
                  media_body=media,
                  fields='id',
                  supportsAllDrives=True
              ).execute()

              print(f"âœ… Uploaded file ID: {uploaded.get('id')}")

          if __name__ == '__main__':
              if len(sys.argv) < 2:
                  print("Usage: python upload_to_drive_oauth.py <file_path>")
                  sys.exit(1)
              upload_file(sys.argv[1])
          EOF

      - name: Upload EXE to Google Drive via OAuth
        run: |
          cd executable
          for file in *.exe; do
            echo "Uploading $file to Google Drive..."
            python ../upload_to_drive_oauth.py "$file"
          done
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
