name: Build and Upload Executable

on:
  push:
    branches:
      - main

env:
  pythonVersion: '3.10'

jobs:

  validate:
    name: Validate Python File
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.pythonVersion }}

      - name: List files
        run: find . -type f

      - name: Validate Python file exists
        run: |
          echo "Validating file path: ${{ inputs.pythonFilePath }}"
          if [ ! -f "${{ inputs.pythonFilePath }}" ]; then
            echo "File not found: ${{ inputs.pythonFilePath }}"
            exit 1
          fi

      - name: Install dependencies
        run: |
          req_path=$(dirname "${{ inputs.pythonFilePath }}")/requirements.txt
          if [ -f "$req_path" ]; then
            pip install -r "$req_path"
          fi

      - name: Validate Python syntax
        run: python -m py_compile "${{ inputs.pythonFilePath }}"

  approval:
    name: Manual Approval
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions
    steps:
      - name: Display approval info
        run: |
          echo "Python file: ${{ inputs.pythonFilePath }}"
          echo "Please review validation results before proceeding."

  build_exe:
    name: Build Executable
    needs: approval
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.pythonVersion }}

      - name: Install dependencies
        run: |
          req_path=$(dirname "${{ inputs.pythonFilePath }}")/requirements.txt
          if [ -f "$req_path" ]; then
            pip install -r "$req_path"
          fi

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build executable
        run: pyinstaller --onefile --clean "${{ inputs.pythonFilePath }}"

      - name: Timestamp EXE
        run: |
          powershell -Command "& {
            $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
            Get-ChildItem -Path dist -Filter *.exe | ForEach-Object {
              Rename-Item $_.FullName ($_.BaseName + '_' + $timestamp + $_.Extension)
            }
          }"

      - name: Upload executable artifact
        uses: actions/upload-artifact@v3
        with:
          name: executable
          path: dist/*.exe

  upload_drive:
    name: Upload to Google Drive
    needs: build_exe
    runs-on: ubuntu-latest
    steps:
      - name: Download executable artifact
        uses: actions/download-artifact@v3
        with:
          name: executable
          path: executable

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.pythonVersion }}

      - name: Install Google Drive API client
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Create upload script
        run: |
          echo "${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}" > service_account.json
          cat > upload_to_drive.py << 'EOF'
          # Python script content here (same as your Azure version)
          EOF

      - name: Upload EXE to Google Drive
        run: |
          cd executable
          for file in *.exe; do
            python ../upload_to_drive.py "$file"
          done
        env:
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}

      - name: Clean up credentials
        run: rm -f service_account.json
