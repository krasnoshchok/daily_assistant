name: Build and Upload Executable

on:
  push:
    branches:
      - main

env:
  pythonVersion: '3.11'
  pythonFilePath: 'app.py'

jobs:

  validate:
    name: Validate Python File
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.pythonVersion }}

      - name: List files
        run: find . -type f

      - name: Validate Python file exists
        run: |
          echo "Validating file path: ${{ env.pythonFilePath }}"
          if [ ! -f "${{ env.pythonFilePath }}" ]; then
            echo "File not found: ${{ env.pythonFilePath }}"
            exit 1
          fi

      - name: Install dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      - name: Validate Python syntax
        run: python -m py_compile "${{ env.pythonFilePath }}"

  approval:
    name: Manual Approval
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions
    steps:
      - name: Display approval info
        run: |
          echo "Python file: ${{ env.pythonFilePath }}"
          echo "Please review validation results before proceeding."

  build_exe:
    name: Build Executable
    needs: approval
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.pythonVersion }}

      - name: Install dependencies
        run: |
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
        shell: pwsh

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build executable
        run: pyinstaller --onefile --clean "${{ env.pythonFilePath }}"

      - name: Timestamp EXE
        run: |
          $timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
          Get-ChildItem -Path dist -Filter *.exe | ForEach-Object {
            Rename-Item $_.FullName ($_.BaseName + '_' + $timestamp + $_.Extension)
          }
        shell: pwsh

      - name: Upload executable artifact
        uses: actions/upload-artifact@v3
        with:
          name: executable
          path: dist/*.exe

  upload_drive:
    name: Upload to Google Drive
    needs: build_exe
    runs-on: ubuntu-latest
    steps:
      - name: Download executable artifact
        uses: actions/download-artifact@v3
        with:
          name: executable
          path: executable

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.pythonVersion }}

      - name: Install Google Drive API client
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Create upload script
        run: |
          cat > upload_to_drive.py << 'EOF'
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          import os
          import sys
          import json

          SCOPES = ['https://www.googleapis.com/auth/drive']
          
          gdrive_folder_id = os.environ.get('GOOGLE_DRIVE_FOLDER_ID')
          service_account_json = os.environ.get('GOOGLE_SERVICE_ACCOUNT_JSON')

          def upload_file(file_path):
              credentials_info = json.loads(service_account_json)
              credentials = service_account.Credentials.from_service_account_info(
                  credentials_info,
                  scopes=['https://www.googleapis.com/auth/drive']
              )
          
              service = build('drive', 'v3', credentials=credentials)

              file_metadata = {
                  'name': os.path.basename(file_path),
                  'parents': [gdrive_folder_id]
              }
              media = MediaFileUpload(file_path, resumable=True)

              uploaded_file = service.files().create(
                  body=file_metadata,
                  media_body=media,
                  fields='id',
                  supportsAllDrives=True
              ).execute()

              print(f"Uploaded file ID: {uploaded_file.get('id')}")

          if __name__ == '__main__':
              if len(sys.argv) < 2:
                  print("Usage: python upload_to_drive.py <file_path>")
                  sys.exit(1)
              upload_file(sys.argv[1])
          EOF

      - name: Upload EXE to Google Drive
        run: |
          cd executable
          for file in *.exe; do
            python ../upload_to_drive.py "$file"
          done
        env:
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}

      - name: Clean up credentials
        run: rm -f service_account.json